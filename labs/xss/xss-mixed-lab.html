<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XSS Mixed Topics Lab â€“ 50 Levels</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:20px;color:#0b1220}
    h1{font-size:22px;margin:0 0 8px}
    .meta{color:#6b7280;font-size:13px;margin-bottom:12px}
    select{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
    textarea{width:100%;height:90px;padding:10px;border-radius:8px;border:1px solid #e6e9ef}
    iframe{width:100%;height:300px;border:1px solid #e6e9ef;border-radius:8px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #e6e9ef;background:#f8fafc;cursor:pointer}
    .level{display:none}
    .level.visible{display:block}
    .muted{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <h1>ðŸ§© XSS Mixed Topics Lab â€” 50 Levels</h1>
  <div class="meta">Practice reflected/stored/DOM/CSP/SVG/URL-context XSS techniques. No hints â€” only the challenge. Unlock next level by triggering <code>alert(document.domain)</code> or <code>alert(window.origin)</code>.</div>

  <label for="sel">Choose Level</label>
  <select id="sel"></select>
  <div style="height:12px"></div>
  <div id="container"></div>

  <script>
    const TOTAL = 50;
    const sel = document.getElementById('sel');
    const container = document.getElementById('container');

    // different sinks/contexts used across levels
    const SINKS = [
      // reflected into innerHTML
      s=>`<div>Result: ${s}</div>`,
      // injected into attribute value
      s=>`<img src=x alt="${s}">`,
      // placed into href
      s=>`<a href="${s}">link</a>`,
      // inside script string
      s=>`<script>var data = "${s}";console.log(data);<\/script>`,
      // inside JS expression
      s=>`<script>try{(0,eval)("${s}")}catch(e){}<\/script>`,
      // inside comment
      s=>`<!-- ${s} --><div>ok</div>`,
      // inside SVG
      s=>`<svg xmlns='http://www.w3.org/2000/svg'>${s}</svg>`,
      // inside style block
      s=>`<style>body::after{content:'${s}';}</style>`,
      // inside textarea (requires breakout)
      s=>`<textarea>${s}</textarea>`,
      // inside data- attribute unquoted
      s=>`<div data-info=${s}>x</div>`,
      // inside JSON in script
      s=>`<script>window.__INJECT=${JSON.stringify(s)};<\/script>`,
      // inside template tag
      s=>`<template>${s}</template>`,
      // inside event handler attribute
      s=>`<button id=btn ${s}>Click</button>`,
      // URL fragment reflected
      s=>`<div id=res>Fragment: <span id=frag></span></div><script>document.getElementById('frag').textContent = location.hash.slice(1);<\/script>`
    ];

    // progressive filters per level to force different techniques
    function sanitizeForLevel(level,input){
      let s = String(input);
      // level groups and filters
      if(level%5===0) s = s.replace(/on\w+\s*=\s*("[^"]*"|'[^']*'|[^>\s]*)/gi,'');
      if(level%7===0) s = s.replace(/<script/gi,'<scr' );
      if(level%6===0) s = s.replace(/javascript:/gi,'');
      if(level%8===0) s = s.replace(/["']/g,'');
      if(level%9===0) s = s.replace(/</g,'&lt;');
      if(level%11===0) s = s.replace(/>/g,'&gt;');
      if(level%13===0) s = s.replace(/\\/g,'');
      if(level%17===0) s = s.replace(/\s+/g,' ');
      // prevent closing script breaking host
      s = s.replace(/<\/script/gi,'<\\/script');
      return s;
    }

    // create UI
    for(let i=1;i<=TOTAL;i++){
      const opt = document.createElement('option'); opt.value=i; opt.textContent=`Level ${i}`; if(i!==1) opt.disabled=true; sel.appendChild(opt);

      const div = document.createElement('div'); div.id=`lvl-${i}`; div.className='level'+(i===1? ' visible':'');
      const sink = SINKS[i % SINKS.length];
      div.innerHTML = `
        <div class=grid>
          <div>
            <textarea id='in-${i}' placeholder='Inject payload here'></textarea>
            <div style='margin-top:8px'><button class='btn' onclick='run(${i})'>Run</button> <button class='btn' onclick='resetF(${i})'>Reset</button></div>
            <div style='margin-top:8px' class='muted'>Context: ${getContextHint(i)}</div>
          </div>
          <div>
            <iframe id='frame-${i}' sandbox='allow-scripts allow-modals'></iframe>
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    sel.addEventListener('change',()=>{
      const v=+sel.value; for(let i=1;i<=TOTAL;i++){ document.getElementById('lvl-'+i).classList.toggle('visible', i===v);}    });

    function getContextHint(i){
      // very small non-actionable hint so user knows DOM sink type without giving payloads
      const types = ['innerHTML','attr','href','script-string','eval-like','comment','svg','style','textarea','data-attr','json-script','template','event-attr','fragment-reflect'];
      return types[i % types.length];
    }

    function buildFrameContent(level, payload){
      const sink = SINKS[level % SINKS.length];
      const sanitized = sanitizeForLevel(level,payload);
      const body = sink(sanitized);
      const html = `<!doctype html><html><body>\n<script>\nconst oldAlert=window.alert; window.alert=function(m){ try{ const ok=[document.domain, window.origin]; if(ok.includes(m)) parent.postMessage({type:'solved',level:${level}},'*'); }catch(e){} return oldAlert.apply(window,arguments);}\n<\/script>\n${body}\n</body></html>`;
      return html;
    }

    window.run = function(level){
      const val = document.getElementById('in-'+level).value||'';
      const frame = document.getElementById('frame-'+level);
      frame.srcdoc = buildFrameContent(level,val);
    }

    window.resetF = function(level){ document.getElementById('frame-'+level).srcdoc='<!doctype html><html><body></body></html>'; }

    // unlock flow
    const unlocked = new Set([1]);
    window.addEventListener('message', (ev)=>{
      if(ev?.data?.type==='solved' && Number.isInteger(ev.data.level)){
        const lvl = Number(ev.data.level);
        if(lvl<TOTAL && !unlocked.has(lvl+1)){
          unlocked.add(lvl+1); sel.querySelector(`option[value="${lvl+1}"]`).disabled=false; alert(`âœ… Level ${lvl} solved â€” unlocked ${lvl+1}`);
        } else if(lvl===TOTAL){ alert(`ðŸŽ‰ All ${TOTAL} solved`); }
      }
    });

    // avoid selecting locked levels via mouse
    sel.addEventListener('mousedown',()=>{ for(const o of sel.options){ if(!unlocked.has(+o.value)) o.disabled=true; }});
  </script>
</body>
</html>
