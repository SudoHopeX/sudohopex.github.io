<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://sudohopex.github.io/img/writeup-doc.webp">
    <title>Easily Document Ethical Hacking Writeups - SudoHopeX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>

        /* Define the custom font stack using a CSS variable */
        :root {
            --custom-serif: 'Times New Roman', Times, serif;
        }

        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* Dark gray */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* Medium gray */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Light gray on hover */
        }
        /* Style for the 'Lab Details' section to prevent cutting off in PDF */
        #lab-details-container {
            padding: 2rem;
            background-color: #1f2937; /* Darker background for the output area */
            color: #f3f4f6;
        }
        /* Specific styling for <pre> to handle code blocks */
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 1rem;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #111827; /* Extra dark background for code */
            color: #facc15; /* Yellow text for code */
            overflow-x: auto; /* Handle long lines gracefully */
        }
        .textarea-code {
            font-family: monospace;
            background-color: #111827 !important;
            color: #facc15 !important;
        }
        .section-header {
            border-bottom: 2px solid #374151;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 font-sans min-h-screen p-4 sm:p-8">

    <div class="max-w-9xl mx-auto">
        <h1 class="text-4xl font-extrabold text-indigo-400 mb-6 border-b border-indigo-500 pb-2">Easily Document E-Hacking Writeup's</h1>
        <p class="text-gray-400 mb-4">Document your ethical hacking writeup. Data is automatically saved to Browser Local Storage until Cleared.</p>
        <p class="text-green-300 mb-4">Spend more time on Hacking, less on documenting.</p>
        <p class="font-mono text-yellow-300 mb-4">Happy Hacking 😉 ~ SudoHopeX</p>

        <div class="grid Slg:grid-rows-3 gap-8">

            <div id="input-form" class="lg:row-span-2 space-y-6 bg-gray-800 p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-semibold text-indigo-300">Writeup Details Input</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="lab-name" placeholder="Lab Name (e.g., XSS Stored Lab #1)" class="p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400">

                    <div>
                        <select id="lab-category" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="" disabled selected>Select Category</option>
                            <option value="XSS">XSS (Cross-Site Scripting)</option>
                            <option value="SQLi">SQLi (SQL Injection)</option>
                            <option value="IDOR">IDOR (Insecure Direct Object Reference)</option>
                            <option value="CSRF">CSRF (Cross-Site Request Forgery)</option>
                            <option value="LFI_RFI">LFI/RFI (Local/Remote File Inclusion)</option>
                            <option value="Command Injection">Command Injection</option>
                            <option value="Business Logic">Business Logic</option>
                            <option value="Other">Other</option>
                        </select>

                        <input type="text" id="lab-category-custom" placeholder="Type custom category name..." class="mt-2 p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 hidden">
                    </div>

                </div>

                <input type="url" id="lab-link" placeholder="Lab Link (e.g., https://portswigger.net/...)" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400">
                <input type="text" id="vulnerable-point" placeholder="Vulnerable Point (e.g., Comment field in blog post)" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400">
                <input type="text" id="lab-domain" placeholder="Final Lab Domain Verification (e.g., /admin-panel/delete-user)" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400">


                <textarea id="scope" placeholder="Scope & Target: Briefly describe the lab's scope and target application." rows="3" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"></textarea>

                <textarea id="tried" placeholder="What is Tried: All attempts, failed payloads, and methodology. (Markdown accepted)" rows="5" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"></textarea>

                <textarea id="worked" placeholder="What Worked: The exact steps and observations that led to success." rows="5" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"></textarea>

                <textarea id="not-worked" placeholder="What Not Worked: Specific failures that helped narrow down the solution." rows="3" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"></textarea>

                <textarea id="final-payload" placeholder="Final Payload" rows="4" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 textarea-code"></textarea>

                <textarea id="final-payload-struct-working" placeholder="Explain Payload structure and working" rows="4" class="p-3 w-full bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400"></textarea>

                <div class="flex flex-wrap gap-4 pt-4">
                    <button id="clear-data" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Clear All Data
                    </button>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl top-8">
                    <h2 class="text-2xl font-semibold text-indigo-300 mb-4">Export Options</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="export-pdf" class="col-span-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4V3a1 1 0 00-1-1H3a1 1 0 000 2h1v12a2 2 0 002 2h8a2 2 0 002-2V4h1a1 1 0 100-2h-1V3a1 1 0 00-1-1H5zm10 2H5v10h10V6zM7 9a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                            Export to PDF
                        </button>
                        <button id="export-txt" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition duration-200">Export .TXT</button>
                        <button id="export-md" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition duration-200">Export .MD</button>
                    </div>
                </div>

                <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl space-y-6 font-sans">
                    <h2 class="text-3xl font-bold text-indigo-300 mb-6 border-b border-gray-700 pb-3">Live Document Preview</h2>

                    <!-- Document Container for Content Preview -->
                    <div id="lab-details-container" class="space-y-8">

                        <div class="border-b border-indigo-500 pb-3">
                            <h2 id="preview-lab-name" class="text-4xl font-extrabold text-indigo-200 leading-tight">Lab Writeup Title</h2>
                            <p id="preview-lab-category" class="text-lg text-gray-400 mt-1 italic font-mono"></p>
                        </div>

                        <!-- Metadata -->
                        <div class="text-lg">
                            <strong class="text-indigo-400">Lab Link:</strong>
                            <a id="preview-lab-link" target="_blank" class="text-blue-400 hover:underline hover:text-blue-300 transition-colors"></a>
                        </div>

                        <!-- Content Sections -->

                        <!-- Scope & Target -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">Scope & Target</h3>
                            <p id="preview-scope" class="text-2xl text-gray-200 whitespace-pre-wrap leading-relaxed font-normal"></p>
                        </div>

                        <!-- Vulnerable Point (Highlighted Code Style) -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">Vulnerable Point</h3>
                            <p id="preview-vulnerable-point" class="text-2xl bg-gray-900 border border-yellow-500/30 p-4 rounded-lg text-yellow-300 whitespace-pre-wrap font-mono leading-relaxed"></p>
                        </div>

                        <!-- What is Tried (Methodology) -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">What is Tried (Methodology)</h3>
                            <p id="preview-tried" class="text-2xl text-gray-200 whitespace-pre-wrap leading-relaxed [font-family:var(--custom-serif)]"></p>
                        </div>

                        <!-- What Not Worked (Key Failures) -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">What Not Worked (Key Failures)</h3>
                            <p id="preview-not-worked" class="text-2xl text-gray-200 whitespace-pre-wrap leading-relaxed [font-family:var(--custom-serif)]"></p>
                        </div>

                        <!-- What Worked (Success Steps) -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">What Worked (Success Steps)</h3>
                            <p id="preview-worked" class="text-2xl text-gray-200 whitespace-pre-wrap leading-relaxed [font-family:var(--custom-serif)]"></p>
                        </div>

                        <!-- Final Payload (Dedicated Code Block) -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">Final Payload</h3>
                            <pre id="preview-final-payload" class="text-lg font-mono bg-black p-4 rounded-lg overflow-x-auto text-green-300 border border-green-500/30 shadow-inner"></pre>
                        </div>

                        <!-- Final Payload Structure & Working -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">Final Payload Structure & Working</h3>
                            <pre id="preview-final-payload-struct-working" class="text-2xl text-gray-400 whitespace-pre-wrap leading-relaxed [font-family:var(--custom-serif)]"></pre>
                        </div>

                        <!-- Scope Verification (Highlighted Success Style) -->
                        <div class="content-section">
                            <h3 class="section-header text-2xl font-bold text-gray-200 border-b border-gray-700 pb-1 mb-2">Scope Verification</h3>
                            <p id="preview-lab-domain" class="text-2xl bg-gray-900 border border-green-500/30 p-4 rounded-lg text-green-400 whitespace-pre-wrap font-mono leading-relaxed"></p>
                        </div>

                    </div>
                </div>

            </div>

        </div>
    </div>

    <script>

        const FIELDS = [
            'lab-name', 'lab-category', 'lab-category-custom', 'lab-link',
            'scope', 'vulnerable-point', 'tried', 'worked', 'not-worked',
            'final-payload','final-payload-struct-working', 'lab-domain'
        ];

        // --- Utility Functions ---

        /**
         * Cleans a string for safe use in filenames.
         * @param {string} str
         * @returns {string} Cleaned string
         */
        function slugify(str) {
            return str
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '') // Remove non-word chars
                .replace(/[\s_-]+/g, '-') // Replace spaces and hyphens with a single hyphen
                .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
        }

        /**
         * Converts the form data into a plain text string.
         * @returns {string}
         */
        function getPlainTextWriteup() {
            const data = getFormData();

            let text = `
==================================================
LAB WRITEUP: ${data['lab-name'] || 'N/A'}
==================================================
Category: ${data['lab-category'] || 'N/A'}
Lab Link: ${data['lab-link'] || 'N/A'}

[+] Scope & Target
--------------------------------------------------
${data.scope || 'No scope provided.'}

[+] Vulnerable Point
--------------------------------------------------
${data['vulnerable-point'] || 'No vulnerable point identified.'}

[+] What is Tried (Methodology)
--------------------------------------------------
${data.tried || 'No attempts recorded.'}

[+] What Not Worked (Key Failures)
--------------------------------------------------
${data['not-worked'] || 'No failures recorded.'}

[+] What Worked (Success Steps)
--------------------------------------------------
${data.worked || 'No success steps recorded.'}

[+] Final Payload
--------------------------------------------------
${data['final-payload'] || 'No final payload.'}

[+] Final Payload Structure & Working
--------------------------------------------------
${data['final-payload-struct-working'] || 'No final payload Structure and working explained.'}

[+] Final Lab Verification
--------------------------------------------------
${data['lab-domain'] || 'No verification path recorded.'}
`;
            return text.trim();
        }

        /**
         * Converts the form data into a Markdown string.
         * @returns {string}
         */
        function getMarkdownWriteup() {
            const data = getFormData();

            let markdown = `
# ${data['lab-name'] || 'Lab Writeup Title'}

**Category:** ${data['lab-category'] || 'N/A'}
**Lab Link:** [${data['lab-link'] || 'N/A'}](${data['lab-link'] || '#'})

---

## 🎯 Scope & Target
${data.scope || '*No scope provided.*'}

## 📍 Vulnerable Point
\`${data['vulnerable-point'] || 'No vulnerable point identified.'}\`

---

## 📝 What is Tried (Methodology)
${data.tried || '*No attempts recorded.*'}

## ❌ What Not Worked (Key Failures)
${data['not-worked'] || '*No failures recorded.*'}

## ✅ What Worked (Success Steps)
${data.worked || '*No success steps recorded.*'}

---

## 💻 Final Payload
\`\`\`
${data['final-payload'] || 'No final payload.'}
\`\`\`

## 💻 Final Payload
${data['final-payload-struct-working'] || 'No final payload Structure and working explained.'}

## 🌐 Final Lab Verification
\`${data['lab-domain'] || 'No verification path recorded.'}\`
`;
            return markdown.trim();
        }

        /**
         * Initiates a file download with the given content and filename.
         * @param {string} content
         * @param {string} filename
         * @param {string} mimeType
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // --- Custom Category Input Logic ---

        /**
         * Toggles the visibility of the custom category input based on the selection.
         */
        function handleCategoryChange() {
            const categorySelect = document.getElementById('lab-category');
            const customInput = document.getElementById('lab-category-custom');

            if (categorySelect.value === 'Other') {
                customInput.classList.remove('hidden');
                customInput.focus(); // Give focus to the new input
            } else {
                customInput.classList.add('hidden');
                customInput.value = ''; // Clear custom value if a standard category is selected
            }
            // Also call saveToLocalStorage to ensure the correct category is saved/previewed
            saveToLocalStorage();
        }


        // --- Local Storage & UI Management ---

        /**
         * Saves all form data to Local Storage.
         */
        function saveToLocalStorage() {
            const data = getFormData();
            localStorage.setItem('labWriteupData', JSON.stringify(data));
            updatePreview(data);
        }

        /**
         * Loads data from Local Storage and populates the form.
         */
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('labWriteupData');
            if (savedData) {
                const data = JSON.parse(savedData);
                FIELDS.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && data[id] !== undefined) {
                        element.value = data[id];
                    }
                });
                updatePreview(data);
            } else {
                // Initialize preview with default values if no data is found
                updatePreview(getFormData());
            }
        }


        /**
         * Gathers all data from the form fields, handling custom category logic.
         * @returns {Object} An object containing all field data.
         */
        function getFormData() {
            const data = {};
            FIELDS.forEach(id => {
                data[id] = document.getElementById(id).value.trim();
            });

            const categorySelect = document.getElementById('lab-category');
            const customInput = document.getElementById('lab-category-custom');

            // Logic to use the custom input value if 'Other' is selected
            if (categorySelect.value === 'Other' && customInput.value) {
                data['lab-category'] = customInput.value.trim();
            } else {
                data['lab-category'] = categorySelect.value.trim();
            }

            return data;
        }


        /**
         * Updates the live preview section with the latest data.
         * @param {Object} data - The writeup data.
         */
        function updatePreview(data) {
            // Helper for setting text/link
            const setText = (id, value, defaultValue) => {
                document.getElementById(id).textContent = value || defaultValue;
            };

            // Basic Fields
            setText('preview-lab-name', data['lab-name'], 'Lab Writeup Title');
            setText('preview-lab-category', data['lab-category'], 'N/A');
            setText('preview-vulnerable-point', data['vulnerable-point'], 'No vulnerable point identified.');
            setText('preview-lab-domain', data['lab-domain'], 'No verification path recorded.');

            // Textarea Fields (use innerHTML/innerText based on context, here we use textContent for safety)
            setText('preview-scope', data.scope, 'No scope provided.');
            setText('preview-tried', data.tried, 'No attempts recorded.');
            setText('preview-not-worked', data['not-worked'], 'No failures recorded.');
            setText('preview-worked', data.worked, 'No success steps recorded.');
            setText('preview-final-payload', data['final-payload'], 'No final payload.');
            setText('preview-final-payload-struct-working', data['final-payload-struct-working'], 'No final payload Structure and working explained.');

            // Link Field
            const linkElement = document.getElementById('preview-lab-link');
            if (data['lab-link']) {
                linkElement.textContent = data['lab-link'];
                linkElement.href = data['lab-link'].startsWith('http') ? data['lab-link'] : `https://${data['lab-link']}`;
            } else {
                linkElement.textContent = 'N/A';
                linkElement.href = '#';
            }
        }

        // --- Event Handlers ---

        /**
         * Clears the form and local storage.
         */
        function handleClearData() {
            if (confirm("Are you sure you want to clear all form data and local storage? This cannot be undone.")) {
                FIELDS.forEach(id => {
                    document.getElementById(id).value = '';
                });
                localStorage.removeItem('labWriteupData');
                loadFromLocalStorage(); // Reset preview
            }
        }

        /**
         * Exports the writeup as a plain text file.
         */
        function handleExportTxt() {
            const textContent = getPlainTextWriteup();
            const filename = slugify(document.getElementById('lab-name').value || 'lab-writeup') + '.txt';
            downloadFile(textContent, filename, 'text/plain');
        }

        /**
         * Exports the writeup as a Markdown file.
         */
        function handleExportMd() {
            const markdownContent = getMarkdownWriteup();
            const filename = slugify(document.getElementById('lab-name').value || 'lab-writeup') + '.md';
            downloadFile(markdownContent, filename, 'text/markdown');
        }

        /**
         * Gets parameters from the URL location search.
         * @returns {Object} An object containing URL parameters.
         */
        function getURLParams() {
            const params = {};
            const urlParams = new URLSearchParams(window.location.search);

            // Check for 'gh' or 'github' (GitHub) and 'li' or 'linkedin' (LinkedIn) parameters
            params.github = urlParams.get('gh') || urlParams.get('github') || null;
            params.linkedin = urlParams.get('li') || urlParams.get('linkedin') || null;

            // Simple check to clean up LinkedIn link if full URL is provided
            if (params.linkedin && params.linkedin.startsWith('https://')) {
                const parts = params.linkedin.split('/').filter(p => p.length > 0);
                // Look for the last segment after 'in/' or 'pub/'
                const index = parts.findIndex(p => p === 'in' || p === 'pub');
                if (index !== -1 && index + 1 < parts.length) {
                    params.linkedin = parts[index + 1];
                } else if (parts.length > 0) {
                    // Fallback for simple link extraction
                    params.linkedin = parts[parts.length - 1];
                }
            }

            return params;
        }


        /**
         * Exports the writeup as a PDF file by building content directly with jsPDF.
         * This version implements a stylized Cover Page, Table of Contents, and a universal footer
         * for a professional, multi-page document structure with enhanced readability.
         */
        async function handleExportPdf() {
            const data = getFormData();
            const filename = slugify(data['lab-name'] || 'lab-writeup') + '.pdf';
            const userLinks = getURLParams(); // Get GitHub/LinkedIn usernames

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15; // mm
            const contentWidth = pageWidth - 2 * margin;

            // Array to store TOC entries (Title, Start Page, End Page)
            const tocEntries = [];

            let cursorY = margin; // Y-coordinate for placing content, starts from margin

            // --- TYPOGRAPHY AND COLORS ---
            const MAIN_FONT = 'times'; // Times for Cover and Body content
            const ACCENT_FONT = 'helvetica'; // Helvetica for TOC and Footer

            const COVER_BG_COLOR = '#0056b3'; // Dark blue for Cover Page
            const COVER_TEXT_COLOR = '#ffffff'; // White text for Cover Page
            const LINK_COLOR_COVER = '#ffc107'; // Gold/Yellow for link contrast
            const bodyBgColor = '#ffffff';
            const ACCENT_COLOR = '#0056b3';
            const TEXT_COLOR = '#333333';
            const LINK_COLOR = '#007bff';
            const SEPARATOR_COLOR = '#cccccc';

            // Code block specific styling
            const CODE_BG_COLOR = '#f7f7f7';
            const CODE_TEXT_COLOR = '#5c6773';
            const CODE_FONT = 'courier';

            // Increased font sizes and line heights
            const bodyFontSize = 22; // Increased by +6 for better readability
            const bodyLineHeight = 12; // Increased for better spacing
            const bodyCharSpace = 0.2; // Not used due to library limitation

            const codeFontSize = 16;
            const codeLineHeight = 6.5;

            const tocFontSize = 22; // Increased by +6 for prominence and tabular look
            const tocLineHeight = 14; // Increased line spacing for tabular look


            // --- UNIVERSAL FOOTER AND PAGE BREAK LOGIC ---

            // Function to check if a page break is needed and add a new page if so
            const checkPageBreak = (requiredSpace) => {
                // -15 to leave reliable space for the universal footer
                if (cursorY + requiredSpace > pageHeight - margin - 15) {
                    pdf.addPage();
                    // Fill the entire page with the light background color
                    pdf.setFillColor(bodyBgColor);
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');
                    cursorY = margin;
                    return true;
                }
                return false;
            };

            // Function to draw the footer and page numbers on every page
            const drawFooter = () => {
                const numPages = pdf.internal.getNumberOfPages();
                // The total number of pages in the document for the "X of Y" count.
                const totalPagesInFooter = numPages;

                for (let i = 1; i <= numPages; i++) {
                    pdf.setPage(i);
                    const footerY = pageHeight - margin + 2; // Position slightly above the bottom margin

                    // Footer Separator Line
                    pdf.setDrawColor(SEPARATOR_COLOR);
                    pdf.setLineWidth(0.5);
                    pdf.line(margin, footerY - 7, margin + contentWidth, footerY - 7);

                    // Footer Content (Always Helvetica, 9pt)
                    pdf.setFont(ACCENT_FONT, 'normal');
                    pdf.setFontSize(9);
                    pdf.setTextColor(TEXT_COLOR);

                    const githubUser = userLinks.github;
                    const linkedinUser = userLinks.linkedin;

                    const githubLinkText = githubUser ? `GitHub: @${githubUser}` : 'GitHub: N/A';
                    const linkedinLinkText = linkedinUser ? `LinkedIn: in/${linkedinUser}` : 'LinkedIn: N/A';
                    const separator = ' | ';

                    // 1. Footer Text (Centered)
                    const footerText = `${githubLinkText}${separator}${linkedinLinkText}`;
                    const footerFontSize = pdf.internal.getFontSize();

                    const textWidth = pdf.getStringUnitWidth(footerText) * footerFontSize / pdf.internal.scaleFactor;
                    const textX = (pageWidth - textWidth) / 2;

                    // Draw the complete footer text
                    pdf.text(footerText, textX, footerY);

                    // 2. Add clickable links if usernames exist
                    let currentX = textX;
                    const linkHeight = 5;
                    const linkY = footerY - 3; // Position link box above text baseline

                    // GitHub Link Area
                    if (githubUser) {
                        const githubWidth = pdf.getStringUnitWidth(githubLinkText) * footerFontSize / pdf.internal.scaleFactor;
                        const githubUrl = `https://github.com/${githubUser}`;
                        pdf.link(currentX, linkY, githubWidth, linkHeight, { url: githubUrl });
                        currentX += githubWidth;
                    } else {
                        currentX += pdf.getStringUnitWidth(githubLinkText) * footerFontSize / pdf.internal.scaleFactor;
                    }

                    // Separator spacing update
                    const separatorWidth = pdf.getStringUnitWidth(separator) * footerFontSize / pdf.internal.scaleFactor;
                    currentX += separatorWidth;

                    // LinkedIn Link Area
                    if (linkedinUser) {
                        const linkedinWidth = pdf.getStringUnitWidth(linkedinLinkText) * footerFontSize / pdf.internal.scaleFactor;
                        const linkedinUrl = `https://linkedin.com/in/${linkedinUser}`;
                        pdf.link(currentX, linkY, linkedinWidth, linkHeight, { url: linkedinUrl });
                    }

                    // Page Number (Right aligned)
                    // Page 1 (i=1) is the Cover and is unnumbered.
                    // All subsequent pages (i >= 2) start numbering from 2 of X.
                    if (i !== 1) {
                        // Display page number starting from 2 (i) out of the total page count (numPages).
                        const pageNumText = `Page ${i} of ${totalPagesInFooter}`;
                        pdf.text(pageNumText, pageWidth - margin - 8, footerY, { align: 'right' });
                    }
                }
                // Set back to the last page of content to finish the PDF export flow
                pdf.setPage(numPages);
            };

            // Helper to render content, handling embedded <code> tags
            const renderContent = (content, isFullCodeBlock = false) => {
                const textParts = content.split(/(<code>.*?<\/code>)/g).filter(p => p.length > 0);
                let currentX = margin;

                for (const part of textParts) {
                    const isCodeSegment = part.startsWith('<code>') && part.endsWith('</code>') || isFullCodeBlock;
                    const cleanPart = isCodeSegment && !isFullCodeBlock ? part.replace(/^<code>|<\/code>$/g, '') : part;
                    const textToRender = isFullCodeBlock ? content : cleanPart;

                    if (isCodeSegment) {
                        // --- Code Block Rendering (IDE look) ---
                        pdf.setFont(CODE_FONT, 'normal');
                        pdf.setFontSize(codeFontSize);
                        pdf.setTextColor(CODE_TEXT_COLOR);

                        const padding = 3;
                        const codeContentWidth = contentWidth - 2 * padding;
                        const splitCode = pdf.splitTextToSize(textToRender, codeContentWidth);
                        const blockHeight = splitCode.length * codeLineHeight + 2 * padding;

                        checkPageBreak(blockHeight);

                        pdf.setFillColor(CODE_BG_COLOR);
                        pdf.rect(margin, cursorY, contentWidth, blockHeight, 'F');

                        cursorY += padding;

                        for (let i = 0; i < splitCode.length; i++) {
                            pdf.text(splitCode[i], margin + padding, cursorY);
                            cursorY += codeLineHeight;
                        }

                        cursorY += padding;

                        pdf.setFont(MAIN_FONT, 'normal');
                        pdf.setFontSize(bodyFontSize);
                        pdf.setTextColor(TEXT_COLOR);
                        currentX = margin;

                        cursorY += 3;
                        if (isFullCodeBlock) return;

                    } else {
                        // --- Normal Text Rendering ---
                        pdf.setFont(MAIN_FONT, 'normal');
                        pdf.setFontSize(bodyFontSize);
                        pdf.setTextColor(TEXT_COLOR);

                        const remainingWidth = pageWidth - currentX - margin;
                        let splitText = pdf.splitTextToSize(textToRender, remainingWidth);

                        for (let i = 0; i < splitText.length; i++) {
                            const line = splitText[i];

                            checkPageBreak(bodyLineHeight);

                            pdf.text(line, currentX, cursorY);
                            cursorY += bodyLineHeight;
                            currentX = margin;
                        }

                        cursorY += 3;
                    }
                }
            };


            // Helper to add a section with title and content
            const addSection = (title, content, isFullCodeBlock = false) => {
                const titleHeight = 8;

                // Check for page break BEFORE adding the title/content
                checkPageBreak(titleHeight + 15);

                // 1. Record the current page number AFTER any potential page break
                const startPage = pdf.internal.getNumberOfPages();
                const entryIndex = tocEntries.length;

                // Push initial entry. We will update endPage after content is rendered.
                // We set endPage to startPage initially.
                tocEntries.push({ title: title, startPage: startPage, endPage: startPage });

                // Add section title
                pdf.setFont(MAIN_FONT, 'bold');
                pdf.setFontSize(20);
                pdf.setTextColor(ACCENT_COLOR);
                pdf.text(title, margin, cursorY);
                cursorY += 2;

                // Draw a separator line
                pdf.setDrawColor(SEPARATOR_COLOR);
                pdf.setLineWidth(0.5);
                pdf.line(margin, cursorY, margin + contentWidth, cursorY);
                cursorY += 7;

                // Add content, triggering custom rendering
                renderContent(content || `No ${title.toLowerCase()} provided.`, isFullCodeBlock);

                // 2. Update the end page number after rendering content is complete
                // This gives the physical page number where the section content ended.
                tocEntries[entryIndex].endPage = pdf.internal.getNumberOfPages();

                // Add extra space below the section
                if (title !== 'Verification' && cursorY < pageHeight - margin - 20) {
                    cursorY += 8;
                }
            };

            // --- TOC GENERATION FUNCTION ---
            const generateTOC = () => {
                // We render directly onto Page 2 which was added as a placeholder.
                pdf.setPage(2);
                cursorY = margin;

                pdf.setFont(ACCENT_FONT, 'bold'); // Use Helvetica for TOC
                pdf.setFontSize(24);
                pdf.setTextColor(ACCENT_COLOR);

                // Center the TOC Title
                let titleText = 'Table of Contents';
                let titleWidth = pdf.getStringUnitWidth(titleText) * pdf.internal.getFontSize() / pdf.internal.scaleFactor;
                let titleX = (pageWidth - titleWidth) / 2;

                pdf.text(titleText, titleX, cursorY);
                cursorY += 15;

                pdf.setDrawColor(SEPARATOR_COLOR);
                pdf.setLineWidth(0.5);
                pdf.line(margin, cursorY, margin + contentWidth, cursorY);
                cursorY += 8;

                pdf.setFont(ACCENT_FONT, 'normal'); // Use Helvetica for TOC entries
                pdf.setFontSize(tocFontSize); // Now 22pt
                pdf.setTextColor(TEXT_COLOR);

                tocEntries.forEach(entry => {
                    const title = entry.title;
                    const startPage = entry.startPage;
                    const endPage = entry.endPage;

                    // Determine page number text: single page or range (inclusive of end page)
                    const pageNumText = startPage === endPage
                        ? String(startPage)
                        : `${startPage}-${endPage}`;

                    const linkTargetPage = startPage; // Link always goes to the start page

                    const pageNumWidth = pdf.getStringUnitWidth(pageNumText) * tocFontSize / pdf.internal.scaleFactor;

                    // Calculate where the title ends and the leader line starts
                    let currentTitleWidth = pdf.getStringUnitWidth(title) * tocFontSize / pdf.internal.scaleFactor;
                    let leaderStartX = margin + currentTitleWidth + 2;

                    // Calculate the total space available for leader dots
                    let leaderEnd = pageWidth - margin - pageNumWidth - 2;

                    // Draw Title (linked to the page)
                    pdf.text(title, margin, cursorY);

                    // Draw Dotted Leader Line
                    pdf.setDrawColor(SEPARATOR_COLOR);
                    pdf.setLineDash([1, 1], 0); // Dotted line pattern
                    pdf.line(leaderStartX, cursorY - 1, leaderEnd, cursorY - 1);

                    // Draw Page Number (Now page range)
                    const linkX = leaderEnd + 2; // Position the number
                    pdf.text(pageNumText, linkX, cursorY);

                    // Add link annotation to the page number/range
                    pdf.link(linkX, cursorY - tocLineHeight + 2, pageNumWidth, tocLineHeight, { pageNumber: linkTargetPage });

                    cursorY += tocLineHeight;

                    // Reset line style
                    pdf.setLineDash([], 0);
                });

                // Set page back to the current last page of content
                pdf.setPage(pdf.internal.getNumberOfPages());
            };


            // --- 1. COVER PAGE RENDERING (Page 1) ---
            pdf.setPage(1);
            cursorY = margin;

            // Background aesthetic for cover page
            pdf.setFillColor(COVER_BG_COLOR);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');
            pdf.setTextColor(COVER_TEXT_COLOR);

            // NEW: Text Overlays (Watermarks)
            const payloads = [
                { text: 'alert(1)', x: pageWidth * 0.3, y: pageHeight * 0.6, size: 30 },
                { text: "' or 1 = 1;--", x: pageWidth * 0.55, y: pageHeight * 0.5, size: 40 },
                { text: "DROP TABLE users;", x: pageWidth * 0.2, y: pageHeight * 0.75, size: 50 },
                { text: "')alert(1,", x: pageWidth * 0.7, y: pageHeight * 0.2, size: 36 },
                { text: "'OR 1=1;--", x: pageWidth * 0.4, y: pageHeight * 0.9, size: 30 },
                { text: "<?php phpinfo(); ?>", x: pageWidth * 0.05, y: pageHeight * 0.1, size: 25 },
                { text: "admin'--", x: pageWidth * 0.8, y: pageHeight * 0.85, size: 45 },
                { text: "<img src=x onerror=alert(1)>", x: pageWidth * 0.1, y: pageHeight * 0.4, size: 33 },
            ];

            // Set transparency to 21% (0.21)
            pdf.setGState(new window.jspdf.GState({ opacity: 0.21 }));
            pdf.setFont(CODE_FONT, 'bold'); // Use code font for payload aesthetics
            pdf.setTextColor(COVER_TEXT_COLOR); // White text

            payloads.forEach(p => {
                pdf.setFontSize(p.size);
                pdf.text(p.text, p.x, p.y);
            });

            pdf.setGState(new window.jspdf.GState({ opacity: 1.0 })); // Reset transparency
            pdf.setFont(MAIN_FONT, 'bold'); // Reset font for cover title

            // 1. TITLE (Left Aligned)
            pdf.setFont(MAIN_FONT, 'bold');
            pdf.setFontSize(42); // Increased from 36
            pdf.setTextColor(COVER_TEXT_COLOR); // Reset to ensure full visibility over transparent text

            const labNameTitle = data['lab-name'] || 'Lab Writeup Title';
            const titleMaxWidth = contentWidth * 0.75;
            const titleLineHeight = 15;

            const titleLines = pdf.splitTextToSize(labNameTitle, titleMaxWidth);

            // Position title closer to the top left
            cursorY = margin + 30;

            for (let i = 0; i < titleLines.length; i++) {
                pdf.text(titleLines[i], margin, cursorY);
                cursorY += titleLineHeight;
            }


            cursorY += 20;

            // 2. LAB LINK (Left Aligned, clickable) ---
            pdf.setFont(MAIN_FONT, 'bold');
            pdf.setFontSize(18);
            pdf.setTextColor(LINK_COLOR_COVER); // Gold link color

            const labLinkText = `Access Lab - URL`;
            const url = data['lab-link'] && data['lab-link'].startsWith('http') ? data['lab-link'] : `https://${data['lab-link']}`;

            let textWidth = pdf.getStringUnitWidth(labLinkText) * pdf.internal.getFontSize() / pdf.internal.scaleFactor;

            pdf.text(labLinkText, margin, cursorY);
            if (data['lab-link']) {
                pdf.link(margin, cursorY - 3, textWidth, 5, { url: url });
            }
            cursorY += 12;

            // 3. CATEGORY ---
            pdf.setFontSize(20);
            pdf.setTextColor(COVER_TEXT_COLOR);
            pdf.text(`Category: ${data['lab-category'] || 'N/A'}`, margin, cursorY);

            // --- 2. TRANSITION TO MAIN CONTENT (Page 2 will be TOC, Page 3 will be content) ---
            // This logic ensures Page 2 is the TOC and content starts correctly on Page 3
            pdf.addPage(); // Now on Physical Page 2 (TOC placeholder)
            pdf.addPage(); // Now on Physical Page 3 (Content starts here)
            cursorY = margin;

            // Set default style for content pages
            pdf.setFillColor(bodyBgColor);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');
            pdf.setTextColor(TEXT_COLOR);

            // --- 3. BODY SECTIONS (Starts on Page 3) ---
            addSection('Scope & Target', data.scope);
            addSection('Vulnerable Point', data['vulnerable-point'], true);
            addSection('What is Tried (Methodology)', data.tried);
            addSection('What Not Worked (Key Failures)', data['not-worked']);
            addSection('What Worked (Success Steps)', data.worked);
            addSection('Final Payload', data['final-payload'], true);
            addSection('Explain Payload structure and working', data['final-payload-struct-working']);
            addSection('Verification', data['lab-domain']);

            // --- 4. GENERATE TOC AND RENDER UNIVERSAL FOOTER ---
            generateTOC();
            drawFooter();

            pdf.save(filename);
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load data and set up preview
            loadFromLocalStorage();

            // **-- New: Custom Category Listener --**
            document.getElementById('lab-category').addEventListener('change', handleCategoryChange);

            // **-- New: Ensure custom input visibility is correct after loading data --**
            // This is important because loadFromLocalStorage runs first and just sets the value.
            // We need to check the value and explicitly show/hide the custom field.
            handleCategoryChange();

            // 2. Set up event listeners for input changes (saving data)
            FIELDS.forEach(id => {
                document.getElementById(id).addEventListener('input', saveToLocalStorage);
            });

            // 3. Set up event listeners for action buttons
            document.getElementById('clear-data').addEventListener('click', handleClearData);
            document.getElementById('export-txt').addEventListener('click', handleExportTxt);
            document.getElementById('export-md').addEventListener('click', handleExportMd);
            document.getElementById('export-pdf').addEventListener('click', handleExportPdf);
        });

    </script>
</body>
<footer>
    <!-- Footer Divider -->
    <hr class="my-8 border-gray-700">
    <!-- Footer Content -->
    <a href="https://github.com/SudoHopeX">
        <img src="https://sudohopex.github.io/img/made-with-love-by-sudohopex.png" alt="Made with ❤️ by SudoHopeX" style="width:301px; display:block; margin: 0px auto;">
    </a>
    <!-- Include made using HTML, Tailwind css, Js-->
    <p class="text-center text-gray-500 text-sm mt-2">Made using HTML, Tailwind CSS, jsPDF & Vanilla JS</p>
</footer>
</html>
